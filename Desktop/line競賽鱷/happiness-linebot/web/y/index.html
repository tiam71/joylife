<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JoyLife â€¢ ä½ çš„ç”Ÿæ´»å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Noto+Serif+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&family=Noto+Serif+TC:wght@400;700;900&family=Yuji+Syuku&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
        }
        /* æ—¥å¼å®‹é«”ï¼Œç”¨æ–¼æ¨™é¡Œæˆ–æ„Ÿæ€§æ–‡å­— */
        .font-serif-tc { font-family: 'Noto Serif TC', serif; }
        
        /* 1. æ¨™æº–æ—¥ç³»è¥¯ç·šé«” (å„ªé›…ã€æ­£å¼) */
        .font-serif-jp { font-family: 'Noto Serif JP', serif; }

        /* 2. å¾©å¤è€æ˜æœé«” (æœ€æœ‰æ™‚å…‰è† å›Šçš„æ„Ÿè¦ºï¼Œåƒæ´»å­—å°åˆ·) âœ¨ æ¨è–¦ */
        .font-retro-jp { font-family: 'Zen Old Mincho', serif; }

        /* 3. æ›¸æ³•æ‰‹å¯«é«” (åƒæ¯›ç­†å­—ï¼Œå¾ˆæº«æŸ”) */
        .font-hand-jp { font-family: 'Yuji Syuku', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- UI/UX ç‰¹æ•ˆå„ªåŒ– --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }

        .recap-bg { 
            background: radial-gradient(circle at center, #1e1b4b 0%, #000000 100%); 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999; color: white;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        
        /* ... ä¿ç•™åŸæœ‰çš„ recap èƒŒæ™¯ç‰¹æ•ˆ ... */
        .recap-bg::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px);
            background-size: 550px 550px, 350px 350px;
            opacity: 0.3; pointer-events: none;
        }      

        /* å‹•ç•«é¡ */
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #333; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* é›ªèŠ±ç‰¹æ•ˆ */
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
        }
        .snow { position: absolute; top: -10px; animation: fall 10s linear infinite; z-index: 5; pointer-events: none; }

        /* --- âœ¨ æ—¥å¼æ™‚å…‰è† å›Šå°ˆå±¬æ¨£å¼ (New) --- */
        
        /* å’Œç´™èƒŒæ™¯ç´‹ç† */
        .bg-washi {
            background-color: #fcfaf2;
            background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
        }

        /* å‚³çµ±ç›´æ›¸æ¨¡å¼ */
        .vertical-rl { 
            writing-mode: vertical-rl; 
            text-orientation: upright; 
            letter-spacing: 0.1em;
        }
        
        /* è¼¸å…¥æ¡†ï¼šä¿¡ç´™åº•ç·šé¢¨æ ¼ */
        .input-washi {
            background: transparent;
            border: none;
            border-bottom: 1px solid #dcdcdc;
            border-radius: 0;
            padding: 12px 0;
            transition: all 0.3s ease;
            color: #4a4a4a;
            font-family: 'Noto Serif TC', serif;
        }
        .input-washi:focus { 
            ring: 0; outline: none; 
            border-bottom-color: #b91c1c; /* æœ±ç´… */
            background: rgba(185, 28, 28, 0.02);
        }
        .input-washi::placeholder { color: #a8a29e; font-style: italic; }

        /* æœ±å°é¢¨æ ¼æŒ‰éˆ• (Hanko) */
        .btn-hanko {
            background-color: #b91c1c; /* æœ±ç´… */
            color: white;
            border-radius: 12px;
            /* æ¨¡æ“¬å°ç« çš„é‚Šæ¡†èˆ‡è³ªæ„Ÿ */
            border: 2px solid #991b1b;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2), 0 4px 6px rgba(185, 28, 28, 0.3);
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }
        .btn-hanko:active { 
            transform: scale(0.96) translateY(2px); 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        }
        /* å°ç« ç´‹ç† */
        .btn-hanko::after {
            content: ''; position: absolute; inset: 0;
            background-image: url("https://www.transparenttextures.com/patterns/rough-cloth.png");
            opacity: 0.3; pointer-events: none;
        }

        /* éƒµç¥¨/è£é£¾é‚Šæ¡† */
        .stamp-border {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 4px;
        }

        /* é€šç”¨æŒ‰éˆ•å„ªåŒ– */
        .btn-primary {
            background: #1e293b; color: white;
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }

    </style>
</head>
<body class="text-slate-800 bg-slate-100">

<div id="app" class="max-w-md mx-auto min-h-screen bg-[#fdfdfd] shadow-2xl relative overflow-hidden flex flex-col border-x border-slate-200/60">

    <div v-if="isLoading" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="loader mb-4 border-slate-200 border-t-slate-800"></div>
        <p class="text-slate-500 text-xs font-serif-jp tracking-widest animate-pulse">{{ loadingText }}</p>
    </div>

    <div v-if="isError" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-8 text-center">
        <i class="fas fa-wifi text-4xl text-slate-200 mb-6"></i>
        <h3 class="font-bold text-lg mb-2 text-slate-800">é€£ç·šå‡ºç¾å•é¡Œ</h3>
        <p class="text-slate-400 text-xs mb-8 leading-relaxed">{{ errorMessage }}</p>
        <button @click="reloadApp" class="btn-primary px-8 py-3 rounded-full text-xs font-bold tracking-wider">é‡æ–°æ•´ç†</button>
    </div>

    <header class="flex justify-between items-center px-6 py-4 sticky top-0 z-30 transition-all glass-panel">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full bg-slate-100 overflow-hidden border border-slate-200 shadow-sm">
                 <img v-if="userAvatar" :src="userAvatar" class="w-full h-full object-cover">
                 <div v-else class="w-full h-full flex items-center justify-center bg-slate-50 text-slate-300"><i class="fas fa-user"></i></div>
            </div>
            <div class="flex flex-col">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Adventure</span>
                <h1 class="font-bold text-base text-slate-800 leading-none">Hi, {{ username }}</h1>
            </div>
        </div>
        <div @click="currentTab = 'shop'" class="flex items-center gap-2 bg-gradient-to-r from-amber-50 to-orange-50 text-amber-700 px-3 py-1.5 rounded-full font-bold text-xs cursor-pointer active:scale-95 transition-transform border border-amber-100/50 shadow-sm">
            <i class="fas fa-coins text-amber-400"></i>
            <span class="font-mono">{{ userPoints }} P</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto hide-scrollbar pb-28 px-5 pt-6">

        <div v-if="currentTab === 'home'" class="animate-fade-in">
            <div @click="openRecap" class="w-full h-44 rounded-3xl bg-slate-900 text-white p-6 mb-8 relative overflow-hidden cursor-pointer shadow-xl shadow-slate-200 group border border-slate-800 transition-all active:scale-[0.98]">
                <div class="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 opacity-80 mix-blend-overlay transition-opacity group-hover:opacity-100"></div>
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
                <div class="relative z-10 flex flex-col h-full justify-between">
                    <div>
                        <div class="inline-block bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-bold mb-3 tracking-widest border border-white/10 text-white/80">MONTHLY RECAP</div>
                        <h2 class="text-2xl font-serif-jp font-bold leading-tight tracking-wide">ä½ çš„å†’éšªäººæ ¼<br>åˆ†æå ±å‘Š</h2>
                    </div>
                    <div class="flex items-center gap-2 text-xs font-bold text-white/80 group-hover:text-white group-hover:translate-x-1 transition">
                        <i class="fas fa-play-circle text-lg"></i> é»æ“Šæ­æ›‰
                    </div>
                </div>
                <i class="fas fa-bolt absolute -right-6 -bottom-6 text-[120px] text-white opacity-5 rotate-12 group-hover:rotate-[20deg] transition-transform duration-700 ease-out"></i>
            </div>

            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-lg font-bold text-slate-800">å¾…è§£é–ä»»å‹™</h2>
                <span class="text-[10px] text-slate-400 bg-slate-100 px-2 py-1 rounded-md font-bold">{{ filteredTodoTasks.length }} å€‹æŒ‘æˆ°</span>
            </div>

            <div class="flex gap-2 overflow-x-auto hide-scrollbar mb-5 pb-2 -mx-5 px-5">
                <button v-for="cat in categoryList" :key="cat" 
                    @click="activeCategory = cat"
                    :class="activeCategory === cat ? 'bg-slate-800 text-white shadow-lg shadow-slate-200' : 'bg-white text-slate-400 border border-slate-100'"
                    class="whitespace-nowrap px-4 py-2.5 rounded-2xl text-xs font-bold transition-all active:scale-95 flex-shrink-0">
                    {{ cat }}
                </button>
            </div>

            <div class="space-y-4">
                <div v-for="task in filteredTodoTasks" :key="task.id" class="bg-white p-5 rounded-[20px] shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] border border-slate-50 relative overflow-hidden group hover:border-slate-200 transition-all">
                    <div :class="`absolute left-0 top-0 bottom-0 w-1.5 ${getCategoryColor(task.category)}`"></div>
                    <div class="pl-2">
                        <div class="flex justify-between items-start mb-2"> 
                            <span class="text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded uppercase tracking-wider font-bold">{{ task.category }}</span>
                            <span class="text-[10px] font-bold text-amber-600 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100">+50 P</span>
                        </div>
                        <h3 class="font-bold text-base text-slate-800 mb-1 group-hover:text-black">{{ task.title }}</h3>
                        <p class="text-xs text-slate-500 line-clamp-1 font-medium">{{ task.subtitle }}</p>
                    </div>
                    <a :href="getLineDeepLink(task)" 
                        class="mt-4 w-full py-3 bg-slate-900 hover:bg-black text-white rounded-xl flex items-center justify-center gap-2 text-xs font-bold active:scale-[0.98] transition-all shadow-lg shadow-slate-200/50">
                        <i class="fab fa-line text-green-400 text-base"></i> ä¸Šå‚³è­‰æ˜
                    </a>
                </div>
                 <div v-if="filteredTodoTasks.length === 0" class="flex flex-col items-center justify-center py-20 opacity-40 text-slate-400">
                    <i class="fas fa-check-circle text-5xl mb-4 text-slate-200"></i>
                    <p class="text-sm font-bold">å¤ªæ£’äº†ï¼æ­¤åˆ†é¡æš«ç„¡å¾…è¾¦</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'event'" class="space-y-6 animate-fade-in">
            <div class="flex justify-between items-end mb-2 px-1">
                <h2 class="text-lg font-bold text-slate-800">é™æ™‚å†’éšª â³</h2>
                <span class="text-[10px] text-rose-500 font-bold bg-rose-50 px-2 py-1 rounded-full animate-pulse">é™é‡ç™¼æ”¾ä¸­</span>
            </div>

            <div class="space-y-5">
                <div v-for="(event, key) in eventConfig" :key="key" 
                     @click="openEvent(key)" 
                     class="relative rounded-[24px] p-6 text-white overflow-hidden shadow-lg cursor-pointer transition-all active:scale-[0.98] shadow-slate-200 group hover:shadow-xl hover:translate-y-[-2px]" 
                     :class="event.bgClass">
                    <div class="relative z-10 flex flex-col h-full justify-between gap-6">
                        <div>
                            <span class="bg-white/20 text-[10px] px-2.5 py-1 rounded-lg backdrop-blur-md border border-white/10 font-bold tracking-wider uppercase">{{ event.tag }}</span>
                            <h3 class="text-xl font-black tracking-tight mt-3 leading-tight font-serif-jp">{{ event.title }}</h3>
                            <p class="text-xs opacity-90 group-hover:opacity-100 mt-1.5 font-medium leading-relaxed max-w-[85%]">{{ event.subtitle }}</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs font-bold opacity-80 group-hover:translate-x-1 transition-transform">
                            <span class="bg-white text-black/80 w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-arrow-right text-[10px]"></i></span>
                            æŸ¥çœ‹è©³æƒ…
                        </div>
                    </div>
                    <i :class="`fas ${event.bgIcon} absolute -right-6 -bottom-6 text-[110px] opacity-10 rotate-12 group-hover:rotate-[20deg] transition-transform duration-700 ease-out`"></i>
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/noise.png')] opacity-20 mix-blend-overlay"></div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'tasks'" class="animate-fade-in">
            <h2 class="text-lg font-bold mb-6 px-1">å†’éšªæ—…ç¨‹ç´€éŒ„</h2>
            <div v-if="completedTasks.length === 0" class="text-center py-20 text-slate-300">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    <i class="fas fa-camera opacity-50"></i>
                </div>
                <p class="font-bold text-slate-400 text-sm">å°šæœªæœ‰å®Œæˆç´€éŒ„ï¼Œå¿«å»æŒ‘æˆ°å§ï¼</p>
            </div>
            <div class="space-y-6 pl-2">
                <div v-for="(task, index) in completedTasks" :key="task.id" 
                     @click="openTaskDetail(task)"
                     class="flex gap-4 group cursor-pointer">
                    <div class="flex flex-col items-center pt-1 w-12 flex-shrink-0 relative">
                        <span class="text-sm font-black text-slate-700 font-mono">{{ getDay(task.completedAt) }}</span>
                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-0.5">{{ getMonth(task.completedAt) }}</span>
                        <div v-if="index !== completedTasks.length - 1" class="absolute top-10 bottom-[-24px] w-px bg-slate-200"></div>
                    </div>
                    <div class="flex-1 bg-white rounded-2xl p-3 shadow-sm flex gap-3 border border-slate-100 transition-all group-hover:shadow-md group-hover:border-slate-200">
                        <img :src="taskImage(task)" class="w-16 h-16 rounded-xl object-cover flex-shrink-0 bg-slate-50 border border-slate-100">
                        <div class="flex flex-col justify-center min-w-0 pr-2">
                            <h3 class="font-bold text-sm text-slate-800 truncate leading-snug">{{ task.title }}</h3>
                            <p class="text-[11px] text-slate-400 mt-1 line-clamp-1">{{ task.subtitle }}</p>
                            <div class="mt-2 flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                <span class="text-[10px] text-emerald-600 font-bold">å·²å®Œæˆ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'badges'" class="animate-fade-in">
            <h2 class="text-lg font-bold mb-1 px-1">æ¦®è€€æ®¿å ‚</h2>
            <p class="text-xs text-slate-400 mb-6 px-1">æ”¶é›†å¾½ç« ï¼Œè­‰æ˜ä½ çš„å†’éšªç²¾ç¥</p>
            
            <div class="grid grid-cols-2 gap-4">
                <div v-for="badge in badges" :key="badge.id" 
                     @click="openBadgeDetail(badge)"
                     :class="badge.unlocked ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100 bg-white opacity-80'"
                     class="border rounded-[24px] p-5 flex flex-col items-center text-center cursor-pointer transition-all active:scale-95 relative overflow-hidden group hover:shadow-lg">
                    
                    <div :class="badge.unlocked ? 'bg-white shadow-lg scale-110 rotate-3 ring-4 ring-amber-50' : 'bg-slate-50 grayscale'" class="w-20 h-20 rounded-full flex items-center justify-center text-4xl mb-3 transition-transform duration-500 overflow-hidden border-2 border-white">
                        <img v-if="badge.imgUrl" :src="badge.imgUrl" class="w-full h-full object-cover">
                        <span v-else>{{ badge.icon }}</span>
                    </div>
                    
                    <h3 class="font-bold text-slate-800 mt-2 text-sm group-hover:text-black">{{ badge.name }}</h3>
                    
                    <div class="mt-3 w-full">
                        <div v-if="badge.unlocked" class="text-[10px] font-bold text-amber-700 bg-amber-100/50 py-1 px-3 rounded-full inline-block">
                             {{ formatDateShort(badge.unlockedAt) }} ç²å¾—
                        </div>
                        <div v-else class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-1">
                            <div class="bg-amber-400 h-full transition-all duration-1000 rounded-full" :style="{width: (badge.count / badge.target)*100 + '%'}"></div>
                            <p class="text-[10px] text-slate-400 mt-1.5 font-bold">{{ badge.count }} / {{ badge.target }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shop'" class="animate-fade-in p-1">
            <div class="bg-gradient-to-br from-amber-400 via-orange-400 to-rose-500 rounded-[32px] p-8 text-white mb-8 text-center shadow-xl shadow-orange-100 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
                <div class="relative z-10">
                    <p class="text-[10px] font-bold opacity-80 tracking-[0.2em] uppercase mb-2">Current Balance</p>
                    <h2 class="text-6xl font-black tracking-tighter pb-1 font-mono">{{ userPoints }}</h2>
                    <div class="mt-4 bg-white/20 backdrop-blur-sm rounded-full py-1.5 px-4 text-xs inline-flex items-center gap-2 font-bold border border-white/20">
                        <i class="fas fa-coins text-amber-200"></i> å†’éšªç©åˆ†
                    </div>
                </div>
            </div>

            <h3 class="font-bold text-lg px-2 mb-4 text-slate-800">çå‹µå…Œæ›</h3>
            <div class="grid grid-cols-2 gap-4">
                <div v-for="item in shopItems" :key="item.id" class="bg-white border border-slate-100 rounded-[24px] p-5 flex flex-col items-center text-center shadow-[0_4px_20px_-10px_rgba(0,0,0,0.1)] hover:shadow-lg transition-all hover:-translate-y-1">
                    <div class="text-5xl mb-4 transition duration-300 hover:scale-110 drop-shadow-sm">{{ item.icon }}</div>
                    <h4 class="font-bold text-slate-800 mb-1 text-sm">{{ item.name }}</h4>
                    <p class="text-[10px] text-slate-400 mb-4 line-clamp-1">{{ item.desc }}</p>
                    <button @click="redeem(item)" 
                        :disabled="userPoints < item.cost"
                        :class="userPoints >= item.cost ? 'bg-slate-900 text-white hover:bg-black shadow-lg shadow-slate-200' : 'bg-slate-100 text-slate-300'"
                        class="w-full py-3 rounded-xl text-xs font-bold transition active:scale-95">
                        {{ item.cost }} P å…Œæ›
                    </button>
                </div>
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 w-full max-w-md border-t border-white/50 flex justify-around py-2 pb-6 z-40 text-[10px] font-bold text-slate-400 glass-panel shadow-[0_-5px_20px_rgba(0,0,0,0.02)]">
        <button @click="currentTab = 'home'" :class="currentTab === 'home' ? 'text-slate-900 scale-105' : 'hover:text-slate-600'" class="flex flex-col items-center gap-1 w-1/4 pt-2 transition-all group">
            <i class="fas fa-compass text-xl mb-0.5 transition-transform duration-300 group-active:scale-90"></i> å†’éšª
        </button>
        <button @click="currentTab = 'event'" :class="currentTab === 'event' ? 'text-rose-600 scale-105' : 'hover:text-slate-600'" class="flex flex-col items-center gap-1 w-1/4 pt-2 transition-all group">
            <i class="fas fa-gift text-xl mb-0.5 transition-transform duration-300 group-active:scale-90" :class="currentTab === 'event' ? 'animate-bounce' : ''"></i> æ´»å‹•
        </button>
        <button @click="currentTab = 'tasks'" :class="currentTab === 'tasks' ? 'text-slate-900 scale-105' : 'hover:text-slate-600'" class="flex flex-col items-center gap-1 w-1/4 pt-2 transition-all group">
            <i class="fas fa-book-journal-whills text-xl mb-0.5 transition-transform duration-300 group-active:scale-90"></i> æ—¥èªŒ
        </button>
        <button @click="currentTab = 'badges'" :class="currentTab === 'badges' ? 'text-slate-900 scale-105' : 'hover:text-slate-600'" class="flex flex-col items-center gap-1 w-1/4 pt-2 transition-all group">
            <i class="fas fa-medal text-xl mb-0.5 transition-transform duration-300 group-active:scale-90"></i> æˆå°±
        </button>
    </nav>

    <div v-if="showSelfModal || showFriendModal" 
         class="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur-sm transition-opacity"
         @click="closeModals">
    </div>

    <div v-if="showSelfModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-washi w-full max-w-md min-h-[500px] relative pointer-events-auto animate-slide-up shadow-2xl overflow-hidden flex" style="border-radius: 4px;">
            
            <div class="w-2 h-full bg-[#8c2a2a] absolute left-0 top-0 bottom-0 opacity-80"></div>
            
            <div class="flex-1 p-8 pl-10 flex flex-col relative">
                <i class="fas fa-certificate text-red-700/5 absolute -top-4 -right-4 text-[150px] rotate-12 pointer-events-none"></i>
                
                <div class="flex flex-row-reverse h-full gap-6">
                    <div class="h-full pt-4 border-l border-stone-300 pl-4 ml-2 flex-shrink-0">
                        <h3 class="font-serif-jp font-black text-2xl text-stone-800 vertical-rl tracking-[0.3em] h-auto leading-loose drop-shadow-sm">
                            æ‹å•“ <span class="text-[#b91c1c] mt-2 inline-block">æœªæ¥ã®ç§ã¸</span>
                        </h3>
                    </div>

                    <div class="flex-1 flex flex-col space-y-8 pt-2">
                        <p class="font-serif-jp text-stone-500 text-xs tracking-widest leading-loose">
                            æ™‚å…‰æµè½‰ï¼Œå‹¿å¿˜åˆå¿ƒã€‚<br>è«‹å¯«ä¸‹çµ¦æœªä¾†çš„å¯„èªã€‚
                        </p>

                        <div class="space-y-6 flex-1">
                            <div>
                                <label class="block font-serif-jp font-bold text-stone-400 text-[10px] mb-1 tracking-widest">é–‹å°æ—¥ (OPEN DATE)</label>
                                <input v-model="capsuleForm.date" type="date" :min="minDate" class="w-full input-washi text-lg text-stone-800 font-bold bg-transparent">
                            </div>

                            <div>
                                <label class="block font-serif-jp font-bold text-stone-400 text-[10px] mb-1 tracking-widest">å…§å®¹ (CONTENT)</label>
                                <textarea v-model="capsuleForm.content" rows="5" placeholder="è¦ªæ„›çš„..." class="w-full input-washi text-base text-stone-800 resize-none leading-loose bg-transparent" style="background-image: linear-gradient(transparent 95%, #e5e5e5 95%); background-size: 100% 2em; line-height: 2em;"></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button @click="submitSelf" class="btn-hanko px-6 py-3 font-serif-jp font-bold tracking-[0.2em] flex items-center gap-2 text-sm">
                                å°ç·˜ <i class="fas fa-stamp text-xs opacity-70"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showFriendModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-washi w-full max-w-md min-h-[450px] relative pointer-events-auto animate-slide-up shadow-2xl overflow-hidden flex flex-col" style="border-radius: 4px;">
            
            <div class="h-1 w-full bg-[#b91c1c] absolute top-0 left-0 right-0 opacity-80"></div>
            <div class="h-1 w-full bg-[#b91c1c] absolute bottom-0 left-0 right-0 opacity-80"></div>

            <div class="p-8 relative z-10 flex-1 flex flex-col">
                
                <div v-if="!generatedLink" class="flex-1 flex flex-col">
                    <div class="text-center mb-8 relative">
                        <div class="inline-block relative">
                            <i class="fas fa-paper-plane text-[#b91c1c] text-2xl mb-3 opacity-80"></i>
                            <h3 class="font-serif-jp font-black text-2xl text-stone-800 tracking-[0.2em]">æ™‚å…‰æŠ•é</h3>
                            <div class="w-full h-px bg-stone-300 mt-3"></div>
                            <div class="w-2/3 h-px bg-stone-300 mt-1 mx-auto"></div>
                        </div>
                    </div>

                    <div class="space-y-6 flex-1 px-2">
                        <div>
                            <label class="block font-serif-jp font-bold text-stone-400 text-[10px] mb-1 tracking-widest">é è¨ˆé€é” (ARRIVAL)</label>
                            <input v-model="capsuleForm.date" type="date" :min="minDate" class="w-full input-washi text-lg text-stone-800 font-bold">
                        </div>
                        <div>
                            <label class="block font-serif-jp font-bold text-stone-400 text-[10px] mb-1 tracking-widest">å¯„èª (MESSAGE)</label>
                            <textarea v-model="capsuleForm.content" rows="3" placeholder="è¦‹å­—å¦‚é¢..." class="w-full input-washi text-base text-stone-800 resize-none"></textarea>
                        </div>
                    </div>
                    
                    <button @click="submitFriend" class="w-full btn-hanko mt-8 py-3.5 font-serif-jp font-bold tracking-[0.2em] shadow-lg">
                        ç”Ÿæˆçµç·£ç¹© (é€£çµ)
                    </button>
                </div>

                <div v-else class="text-center flex-1 flex flex-col items-center justify-center py-4 animate-fade-in">
                    <div class="w-24 h-24 border-[3px] border-[#b91c1c] rounded-full flex items-center justify-center mb-5 text-[#b91c1c] relative">
                         <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/rough-cloth.png')] opacity-30 rounded-full"></div>
                        <span class="font-serif-jp font-black text-3xl writing-vertical vertical-rl tracking-widest">æ‰¿èª</span>
                    </div>
                    <h3 class="font-serif-jp font-bold text-xl text-stone-800 mb-2">çµç·£ç¹©å·²ç·¨ç¹”</h3>
                    <p class="font-serif-jp text-sm text-stone-500 mb-8 leading-relaxed">è«‹å°‡æ­¤ç¹©çµå‚³éçµ¦å°æ–¹ï¼Œ<br>å¾…å°æ–¹ç¹«ä¸Š(é»æ“Š)å¾Œæ–¹ç”Ÿæ•ˆã€‚</p>
                    
                    <div class="w-full bg-stone-100 p-4 rounded border border-stone-200 text-xs text-stone-500 break-all mb-6 select-all font-mono">
                        {{ generatedLink }}
                    </div>

                    <button @click="copyLink" class="w-full bg-stone-800 text-white py-3.5 rounded-lg font-serif-jp font-bold hover:bg-black transition shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-copy"></i> è¤‡è£½ä¸¦å‚³é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="selectedTask" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none transition-opacity">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm pointer-events-auto" @click="selectedTask = null"></div>
        <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-6 pb-10 relative z-10 pointer-events-auto animate-slide-up shadow-2xl">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <img :src="taskImage(selectedTask)" class="w-full h-64 object-cover rounded-[20px] shadow-lg mb-6 border border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-4">
                <span :class="`px-3 py-1 rounded-lg text-[10px] font-bold ${getCategoryColor(selectedTask.category)}`">{{ selectedTask.category }}</span>
                <span class="text-xs text-slate-400 font-bold font-mono"><i class="far fa-clock mr-1.5"></i>{{ formatDateFull(selectedTask.completedAt) }}</span>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-3 leading-snug">{{ selectedTask.title }}</h2>
            <p class="text-slate-500 text-sm leading-relaxed italic border-l-4 border-slate-200 pl-4 py-1 bg-slate-50/50 rounded-r-lg">"{{ selectedTask.subtitle }}"</p>
            <button @click="selectedTask = null" class="w-full mt-8 py-4 bg-slate-100 hover:bg-slate-200 rounded-xl font-bold text-sm text-slate-600 transition active:scale-95">é—œé–‰è©³æƒ…</button>
        </div>
    </div>

    <div v-if="selectedBadge" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none transition-opacity">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm pointer-events-auto" @click="selectedBadge = null"></div>
        <div class="bg-white w-full max-w-md h-[85vh] rounded-t-[32px] sm:rounded-[32px] relative z-10 pointer-events-auto flex flex-col animate-slide-up overflow-hidden shadow-2xl">
            <div class="p-8 pb-6 text-center border-b border-slate-100 bg-white z-10 relative">
                 <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-300 via-orange-400 to-rose-400"></div>
                <div class="w-28 h-28 mx-auto rounded-full bg-amber-50 flex items-center justify-center text-6xl mb-5 overflow-hidden shadow-xl border-4 border-white ring-1 ring-amber-100">
                    <img v-if="selectedBadge.imgUrl" :src="selectedBadge.imgUrl" class="w-full h-full object-cover">
                    <span v-else>{{ selectedBadge.icon }}</span>
                </div>
                <h2 class="text-2xl font-black text-slate-800 mb-1">{{ selectedBadge.name }}</h2>
                <div v-if="selectedBadge.unlocked" class="text-[10px] font-bold text-amber-700 bg-amber-100 py-1.5 px-4 rounded-full inline-block mt-3 shadow-sm border border-amber-200">
                    ğŸ† æ–¼ {{ formatDateShort(selectedBadge.unlockedAt) }} æ¦®è€€è§£é–
                </div>
                <p class="text-sm text-slate-500 mt-5 font-medium leading-relaxed px-4">{{ selectedBadge.desc }}</p>
            </div>
            <div class="flex-1 overflow-y-auto p-6 hide-scrollbar bg-slate-50">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 ml-1">è§£é–ç´€éŒ„ ({{ getBadgeTasks(selectedBadge).length }})</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="task in getBadgeTasks(selectedBadge)" :key="task.id" 
                         @click="selectedTask = task"
                         class="aspect-square rounded-2xl overflow-hidden relative group cursor-pointer bg-white border shadow-sm hover:shadow-lg hover:scale-[1.02] hover:border-slate-300 transition-all">
                        <img :src="taskImage(task)" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <span class="text-white text-xs font-bold border border-white/50 px-3 py-1 rounded-full backdrop-blur-sm">æŸ¥çœ‹</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white border-t border-slate-100 z-10">
                <button @click="selectedBadge = null" class="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95 transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div v-if="activeEvent" class="fixed inset-0 z-[70] flex flex-col pointer-events-none transition-opacity">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md pointer-events-auto" @click="activeEvent = null"></div>
        
        <div v-if="activeEvent === 'xmas'" class="absolute inset-0 pointer-events-none overflow-hidden">
            <div v-for="i in 20" :key="i" class="snow" :style="randomSnowStyle()">â„ï¸</div>
        </div>

        <div class="relative z-10 m-auto w-[90%] max-w-sm bg-white rounded-[32px] overflow-hidden pointer-events-auto animate-slide-up shadow-2xl">
            <div :class="currentEventData.headerClass" class="h-48 flex flex-col items-center justify-center text-white p-6 relative">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
                <button @click="activeEvent = null" class="absolute top-4 right-4 w-8 h-8 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center active:scale-95 transition border border-white/10"><i class="fas fa-times text-white"></i></button>
                <i :class="`fas ${currentEventData.icon}`" class="text-6xl mb-4 z-10 drop-shadow-md"></i>
                <h2 class="text-2xl font-black z-10 leading-tight tracking-tight font-serif-jp">{{ currentEventData.title }}</h2>
            </div>
            <div class="p-8">
                <p class="text-slate-600 text-sm leading-relaxed mb-8 font-medium">{{ currentEventData.desc }}</p>
                <div class="bg-slate-50 rounded-2xl p-4 mb-8 border border-slate-100">
                    <h4 class="text-[10px] font-bold text-slate-400 mb-3 uppercase tracking-wider">é”æˆçå‹µ</h4>
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-white shadow-md flex items-center justify-center text-2xl border border-slate-100">
                            {{ currentEventData.badgeIcon }}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-800">{{ currentEventData.badgeName }}</p>
                            <p class="text-xs text-amber-600 font-bold mt-0.5">+100 å†’éšªç©åˆ†</p>
                        </div>
                    </div>
                </div>
                <a :href="getLineDeepLink('æ´»å‹•ä»»å‹™:' + currentEventData.title)" 
                   class="flex items-center justify-center gap-2 w-full py-4 rounded-2xl bg-slate-900 hover:bg-black text-white text-sm font-bold shadow-xl shadow-slate-300 active:scale-95 transition">
                    <i class="fab fa-line text-green-400 text-xl"></i> ç«‹å³å‰å¾€ä¸Šå‚³
                </a>
            </div>
        </div>
    </div>

    <transition name="fade">
        <div v-if="showRecap" class="fixed inset-0 z-[60] recap-bg flex flex-col items-center text-center overflow-hidden backdrop-blur-md bg-black/95">
             <div class="absolute top-4 left-0 w-full px-4 flex gap-1.5 z-50">
                <div v-for="i in 3" :key="i" class="h-1 bg-white/20 rounded-full flex-1 overflow-hidden backdrop-blur-sm">
                    <div class="h-full bg-white shadow-[0_0_10px_white] transition-all duration-500" 
                         :style="{ width: recapStep > i ? '100%' : (recapStep === i ? '100%' : '0%') }"></div>
                </div>
            </div>
            <button @click="showRecap = false" class="absolute top-10 right-6 text-white/50 z-50 hover:text-white bg-white/10 backdrop-blur-md rounded-full w-10 h-10 flex items-center justify-center transition"><i class="fas fa-times text-xl"></i></button>

            <div class="absolute inset-y-0 left-0 w-1/3 z-40" @click="prevRecapStep"></div>
            <div class="absolute inset-y-0 right-0 w-1/3 z-40" @click="nextRecapStep"></div>

            <div v-if="recapStep === 1" class="w-full h-full flex flex-col justify-center items-center px-7 pt-10 animate-slide-up relative">
                <div class="mb-10 text-center">
                    <div class="text-[10px] font-bold opacity-60 tracking-[0.3em] mb-4 uppercase">DECEMBER Report</div>
                    <div class="text-3xl font-black mb-1 font-serif-jp">{{ username }}</div>
                    <div class="text-xs opacity-60 font-medium">ä½ çš„å†’éšªç¸½çµ</div>
                </div>
                <div class="relative mb-16 w-full text-center">
                    <i class="fas fa-quote-left absolute -top-8 left-0 text-3xl opacity-10 block mb-2"></i>
                    <h2 class="text-5xl font-black leading-tight tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-amber-100 via-white to-amber-200 pb-2 font-serif-jp">{{ personaData.title }}</h2>
                    <i class="fas fa-quote-right absolute -bottom-8 right-0 text-3xl opacity-10 block mt-2 text-right"></i>
                </div>
                <div class="bg-white/5 backdrop-blur-xl rounded-[24px] p-8 w-full max-w-xs border border-white/10 shadow-2xl ring-1 ring-white/5">
                    <p class="text-sm font-light leading-relaxed opacity-90 mb-6 text-left text-slate-200">{{ personaData.desc }}</p>
                    <div class="h-px bg-white/10 w-full mb-5"></div>
                    <div class="flex justify-between items-center text-xs font-bold">
                        <span class="opacity-60">å°ˆæ³¨é ˜åŸŸ</span>
                        <span :class="personaData.colorClass" class="bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-md border border-white/10 shadow-inner">{{ personaData.topCategory }}</span>
                    </div>
                </div>
                <p class="absolute bottom-12 text-[10px] opacity-40 animate-pulse tracking-widest">é»æ“Šå³å´ç¹¼çºŒ</p>
            </div>

            <div v-if="recapStep === 2" class="w-full h-full flex flex-col justify-center items-center px-6 animate-slide-up">
                <h3 class="text-3xl font-black mb-12 text-white font-serif-jp tracking-wide">æœ¬æœˆæ¦®è€€</h3>
                <div v-if="monthlyBadges.length > 0" class="grid grid-cols-2 gap-5 w-full max-w-sm px-2">
                    <div v-for="badge in monthlyBadges" :key="badge.id" class="bg-white/10 border border-white/20 rounded-[24px] p-5 flex flex-col items-center aspect-square justify-center backdrop-blur-lg shadow-lg animate-slide-up transition hover:scale-105 hover:border-amber-400 group">
                        <div class="text-5xl mb-4 drop-shadow-[0_0_15px_rgba(255,215,0,0.4)] transition-transform group-hover:rotate-12 group-hover:scale-110 duration-500">
                             <img v-if="badge.imgUrl" :src="badge.imgUrl" class="w-full h-full object-cover rounded-full ring-4 ring-white/20">
                             <span v-else>{{ badge.icon }}</span>
                        </div>
                        <div class="font-bold text-sm tracking-widest">{{ badge.name }}</div>
                        <div class="text-[10px] text-white/50 mt-1.5 font-bold uppercase tracking-wider">{{ formatDateShort(badge.unlockedAt) }}</div>
                    </div>
                </div>
                <div v-else class="text-center opacity-70 py-16 bg-white/5 rounded-3xl w-full max-w-xs border border-white/10 backdrop-blur-lg">
                    <div class="text-6xl mb-6 grayscale opacity-50">ğŸŒ±</div>
                    <p class="font-bold text-sm leading-loose">é€™å€‹æœˆä½ åœ¨ç©è“„èƒ½é‡<br>ä¸‹å€‹æœˆå°±æ˜¯ä½ çš„èˆå°</p>
                </div>
                <div class="mt-12 text-center bg-gradient-to-r from-amber-500/10 to-orange-500/10 px-8 py-5 rounded-2xl border border-amber-500/30 backdrop-blur-sm">
                    <p class="text-3xl font-black text-amber-300 drop-shadow font-mono">+{{ monthlyPoints }} P</p>
                    <p class="text-[9px] uppercase tracking-[0.2em] opacity-60 mt-1 font-bold">Total Earned</p>
                </div>
            </div>

            <div v-if="recapStep === 3" class="w-full h-full flex flex-col justify-center items-center px-6 animate-slide-up">
                <h3 class="text-3xl font-black mb-2 text-white font-serif-jp tracking-wide">å†’éšªè¶³è·¡</h3>
                <p class="text-[9px] opacity-60 mb-12 tracking-[0.3em] font-bold text-cyan-200 uppercase">Past 5 Months Activity</p>
                
                <div class="w-full max-w-sm mb-12">
                    <div class="h-[220px] flex justify-between gap-4 px-2 border-b border-white/10 relative">
                        <div class="absolute inset-0 flex flex-col justify-between opacity-10 pointer-events-none z-0 py-6">
                            <div class="w-full h-px border-t border-dashed border-white"></div>
                            <div class="w-full h-px border-t border-dashed border-white"></div>
                            <div class="w-full h-px border-t border-dashed border-white"></div>
                            <div class="w-full h-px border-t border-dashed border-white"></div>
                        </div>

                        <div v-for="(stat, index) in fiveMonthStats" :key="stat.month" 
                             class="flex-1 flex flex-col items-center justify-end relative z-10 group cursor-pointer h-full"
                             @click="vibrateDevice">
                            
                            <div class="mb-3 text-xs font-black text-white transition-all duration-500 font-mono"
                                 :class="stat.count > 0 ? 'opacity-100' : 'opacity-0'">
                                 {{ stat.count }}
                            </div>
                            
                            <div class="w-full rounded-t-sm relative transition-all duration-1000 ease-[cubic-bezier(0.34,1.56,0.64,1)]" 
                                 :class="[
                                    stat.isCurrent 
                                        ? 'bg-gradient-to-t from-cyan-600 to-cyan-300 shadow-[0_0_20px_rgba(34,211,238,0.4)] opacity-100' 
                                        : 'bg-white/20 opacity-60'
                                 ]"
                                 :style="getBarStyle(stat.count, index)">
                            </div>
                        </div>
                    </div>
                  
                    <div class="flex justify-between px-2 mt-4 gap-4">
                        <div v-for="stat in fiveMonthStats" :key="stat.month + '_label'" 
                             class="flex-1 text-center">
                             <span class="text-[10px] font-bold tracking-widest uppercase py-1 w-full block transition-all"
                                  :class="stat.isCurrent ? 'text-cyan-300' : 'text-white/30'">
                                {{ stat.month }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 w-full max-w-xs relative z-20">
                    <button @click="shareRecap" class="w-full py-4 bg-white text-slate-900 font-bold rounded-full shadow-[0_0_30px_rgba(255,255,255,0.2)] active:scale-[0.98] transition-all hover:shadow-[0_0_40px_rgba(255,255,255,0.4)] flex items-center justify-center gap-2 group">
                        <i class="fas fa-share-alt group-hover:rotate-12 transition-transform"></i> åˆ†äº«æˆ‘çš„å†’éšªäººæ ¼
                    </button>
                    <button @click="showRecap = false" class="mt-6 text-xs text-white/30 underline font-medium hover:text-white transition-colors">é—œé–‰å†’éšªç¸½çµ</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBBdy_g3mSzxv4vsbutVBkamRKEskVV3Vw",
        authDomain: "joyline-61e03.firebaseapp.com",
        projectId: "joyline-61e03",
        storageBucket: "joyline-61e03.firebasestorage.app",
        messagingSenderId: "800400034535",
        appId: "1:800400034535:web:0bd4a8a8cd613b4920f042"
    };
    const LIFF_ID = "2008223484-qgJsGp1j"; 

    // åˆå§‹åŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
        setup() {
            // --- State ---
            const currentUserId = ref(null);
            const username = ref("å†’éšªè€…");
            const userAvatar = ref(null);
            const userPoints = ref(0);
            const tasks = ref([]);
            const isLoading = ref(true);
            const loadingText = ref("æ­£åœ¨é€£ç·šåˆ° JoyLife...");
            const isError = ref(false);
            const errorMessage = ref("");
            
            const currentTab = ref('home');
            const activeCategory = ref('å…¨éƒ¨');
            const categoryList = ['å…¨éƒ¨', 'è‡ªæˆ‘æŒ‘æˆ°', 'å­¸ç¿’æˆå°±', 'å®¶åº­é—œæ‡·', 'å‹æƒ…å‡æº«', 'å­¸ç¿’æ¢ç´¢', 'ç¤¾æœƒåƒèˆ‡'];
            
            // UI State for Features
            const showRecap = ref(false);
            const recapStep = ref(1);
            const selectedTask = ref(null);
            const selectedBadge = ref(null);
            const activeEvent = ref(null);
            const fiveMonthStats = ref([]); 

            // --- Time Capsule State ---
            const showSelfModal = ref(false);
            const showFriendModal = ref(false);
            const capsuleForm = ref({ date: '', content: '' });
            const generatedLink = ref('');

            // Shop Data
            const shopItems = ref([
                { id: 1, name: 'ä»»å¹¸æŠ½çåˆ¸', desc: 'è©¦è©¦çœ‹ä½ çš„é‹æ°£', cost: 10, icon: 'ğŸŸï¸' },
                { id: 2, name: 'è§£é–é™å®šæ¡Œå¸ƒ', desc: 'æ‰‹æ©Ÿè³ªæ„Ÿå¤§å‡ç´š', cost: 500, icon: 'ğŸ“±' },
                { id: 3, name: 'å’–å•¡å…Œæ›åˆ¸', desc: 'è¾›è‹¦äº†ï¼Œå–æ¯å’–å•¡å§', cost: 1000, icon: 'â˜•' },
                { id: 4, name: 'ç¥ç§˜å¤§ç', desc: 'é€™æ˜¯ä¸€å€‹é©šå–œ', cost: 5000, icon: 'ğŸ' },
            ]);

            // Event Configuration
            const eventConfig = {
                xmas: {
                    action: 'default',
                    tag: "ğŸ„ è–èª•é™å®š", title: "äº¤æ›ã€ŒçœŸå¿ƒã€æ‰‹å¯«å¡", subtitle: "ä¸Šå‚³æ„Ÿè¬ï¼Œæ›å–è–èª•é™å®šå¾½ç« ",
                    bgClass: "bg-gradient-to-br from-emerald-800 to-teal-900", bgIcon: "fa-snowflake",
                    icon: "fa-gift", headerClass: "bg-gradient-to-br from-emerald-800 to-teal-900",
                    desc: "é€™ä»½ç¦®ç‰©ä¸èŠ±éŒ¢ï¼Œä½†æœ€çè²´ã€‚è«‹æ‹ä¸‹ä¸€å¼µçµ¦å®¶äººæˆ–æœ‹å‹çš„ã€Œæ‰‹å¯«æ„Ÿè¬å¡ã€ï¼Œæˆ‘å€‘å°‡ç‚ºä½ ç”Ÿæˆæ•¸ä½è³€å¡ï¼Œè®“ä½ è½‰ç™¼çµ¦å°æ–¹ã€‚",
                    badgeIcon: "ğŸ¦Œ", badgeName: "è–èª•é¦´é¹¿å¾½ç« "
                },
                newyear: {
                    action: 'open_self', // å®šç¾©å‹•ä½œï¼šå¯„çµ¦è‡ªå·±
                    tag: "ğŸ§§ æ–°å¹´é™å®š", title: "2026 æ™‚å…‰è† å›Š", subtitle: "å¯„çµ¦ä¸€å¹´å¾Œè‡ªå·±çš„ä¸€å¥è©±",
                    bgClass: "bg-gradient-to-br from-red-700 to-rose-900", bgIcon: "fa-hourglass-half",
                    icon: "fa-calendar-check", headerClass: "bg-gradient-to-br from-red-700 to-rose-900",
                    desc: "å°æœªä¾†çš„è‡ªå·±å¤§è²èªªè©±ã€‚ç•™ä¸‹çµ¦ 2026 å¹´çš„ä¸€å¥è©±æˆ–ç…§ç‰‡ï¼Œæˆ‘å€‘æœƒåœ¨æ˜å¹´å…ƒæ—¦ç•¶å¤©ï¼Œæº–æ™‚æ¨æ’­çµ¦ä½ ã€‚",
                    badgeIcon: "â³", badgeName: "æ™‚å…‰æ—…äººå¾½ç« "
                },
                newyearforfriends: {
                    action: 'open_friend', // å®šç¾©å‹•ä½œï¼šå¯„çµ¦æœ‹å‹
                    tag: "ğŸ§§ æ–°å¹´é™å®š", title: "åŸ‹ä¸€å€‹æ™‚å…‰è† å›Š", subtitle: "å¯„çµ¦æœ‹å‹çš„æœªä¾†ä¿¡", 
                    bgClass: "bg-gradient-to-br from-rose-500 to-pink-600", bgIcon: "fa-paper-plane", 
                    icon: "fa-envelope-open-text", headerClass: "bg-gradient-to-br from-rose-500 to-pink-600",                     
                    desc: "é€™æ˜¯ä¸€ä»½è·¨è¶Šæ™‚é–“çš„é©šå–œã€‚å¯«ä¸‹çµ¦æœ‹å‹çš„ä¸€æ®µè©±ï¼Œç”Ÿæˆå°ˆå±¬ã€Œæ™‚å…‰é€£çµã€å‚³çµ¦å°æ–¹ã€‚",
                    badgeIcon: "ğŸ’Œ", badgeName: "æ™‚å…‰ä¿¡ä½¿å¾½ç« "
                },
                spring: {
                    action: 'default',
                    tag: "ğŸŒ¸ æ˜¥å­£é™å®š", title: "éˆé­‚æ–·æ¨é›¢", subtitle: "æ¸…ç†ä¸€å¼µæ¨ä¸å¾—åˆªçš„ç…§ç‰‡",
                    bgClass: "bg-gradient-to-br from-lime-600 to-green-700", bgIcon: "fa-leaf",
                    icon: "fa-seedling", headerClass: "bg-gradient-to-br from-lime-600 to-green-700",
                    desc: "æ¸…ç†å¿ƒéˆçš„å¡µåŸƒã€‚è«‹æˆªåœ–è­‰æ˜ä½ åˆªé™¤äº†ä¸€å¼µæ¨ä¸å¾—åˆªçš„ç…§ç‰‡ï¼Œæˆ–å–æ¶ˆé—œæ³¨ä¸€å€‹è®“ä½ æ„Ÿåˆ°ç„¦æ…®çš„å¸³è™Ÿã€‚",
                    badgeIcon: "ğŸƒ", badgeName: "æ˜¥æ›‰æ–°ç”Ÿå¾½ç« "
                }
            };

            function openEvent(key) {
                const config = eventConfig[key];
                
                if (config.action === 'open_self') {
                    capsuleForm.value = { date: '', content: '' };
                    showSelfModal.value = true;
                } else if (config.action === 'open_friend') {
                    capsuleForm.value = { date: '', content: '' };
                    generatedLink.value = '';
                    showFriendModal.value = true;
                } else {
                    activeEvent.value = key;
                }
            }

            function closeModals() {
                showSelfModal.value = false;
                showFriendModal.value = false;
            }

            async function submitSelf() {
                if(!capsuleForm.value.date || !capsuleForm.value.content) {
                    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼');
                    return;
                }

                const originalText = loadingText.value;
                isLoading.value = true;
                loadingText.value = "æ­£åœ¨å°å­˜æ™‚å…‰è† å›Š...";

                try {
                    const uid = currentUserId.value;
                    if (!uid) {
                        alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼Œè«‹é‡æ–°æ•´ç†ã€‚");
                        return;
                    }

                    const response = await fetch('https://detra-funereal-pitilessly.ngrok-free.dev/api/createCapsule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json','ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({
                            userId: uid,
                            content: capsuleForm.value.content,
                            date: capsuleForm.value.date,
                            receiverId: uid 
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(`ğŸ”’ å°å­˜æˆåŠŸï¼\n\nç³»çµ±å·²è¨­å®šæ’ç¨‹ï¼Œé€™å°ä¿¡å°‡æœƒåœ¨ ${capsuleForm.value.date} æº–æ™‚é€é LINE å¯„çµ¦ä½ ã€‚`);
                        closeModals();
                        confetti({particleCount: 150, spread: 70, origin: {y: 0.6}, colors: ['#b91c1c', '#fcd34d']});
                    } else {
                        alert('å°å­˜å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    }

                } catch (e) {
                    console.error("API Error:", e);
                    alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä¼ºæœå™¨ç‹€æ…‹");
                } finally {
                    isLoading.value = false;
                    loadingText.value = originalText;
                }
            }

            async function submitFriend() {
                if(!capsuleForm.value.date || !capsuleForm.value.content) {
                    alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼');
                    return;
                }

                const originalText = loadingText.value;
                isLoading.value = true;
                loadingText.value = "æ­£åœ¨ç·¨ç¹”é€£çµ...";

                try {
                    const uid = currentUserId.value;
                    
                    if (!uid) {
                        alert("ç„¡æ³•å–å¾—ä½¿ç”¨è€… IDï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ LINE ç™»å…¥ç‹€æ…‹ã€‚");
                        isLoading.value = false;
                        return;
                    }

                    const response = await fetch('https://detra-funereal-pitilessly.ngrok-free.dev/api/createCapsule', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({
                            userId: uid,
                            content: capsuleForm.value.content,
                            date: capsuleForm.value.date
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        generatedLink.value = data.link; 
                        console.log("è† å›Šå»ºç«‹æˆåŠŸ ID:", data.capsuleId);
                    } else {
                        console.error("å¾Œç«¯å›å ±éŒ¯èª¤:", data);
                        alert('è£½ä½œå¤±æ•—ï¼š' + (data.error || 'ä¼ºæœå™¨ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤'));
                    }

                } catch (e) {
                    console.error("API é€£ç·šéŒ¯èª¤:", e);
                    alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ç¢ºèªå¾Œç«¯æ˜¯å¦å·²å•Ÿå‹•ã€‚");
                } finally {
                    isLoading.value = false;
                    loadingText.value = originalText;
                }
            }

            function copyLink() {
                if(navigator.clipboard) {
                    navigator.clipboard.writeText(generatedLink.value).then(() => {
                        alert("ğŸ“‹ é€£çµå·²è¤‡è£½ï¼å¿«å»å‚³çµ¦æœ‹å‹å§ï¼");
                        closeModals();
                    });
                } else {
                    alert("è«‹æ‰‹å‹•é¸å–ä¸¦è¤‡è£½é€£çµ");
                }
            }

            // --- Helpers ---
            const fixPhotoUrl = (url) => {
                if (!url) return 'https://via.placeholder.com/300?text=No+Image';
                if (url.includes('/uploads/')) {
                    const parts = url.split('/uploads/');
                    if (parts.length > 1) {
                        const rawPath = 'uploads/' + decodeURIComponent(parts[1]); 
                        return `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/${encodeURIComponent(rawPath)}?alt=media`;
                    }
                }
                if (url.startsWith('http') && !url.includes('gs://')) return url;
                return url; 
            };

            const parseDate = (val) => {
                if (!val) return new Date();
                if (typeof val === 'string') return new Date(val); 
                if (val.seconds) return new Date(val.seconds * 1000); 
                return new Date(val);
            };

            const todoTasks = computed(() => tasks.value.filter(t => t.status === 'todo'));
            const completedTasks = computed(() => 
                tasks.value.filter(t => t.status === 'completed').sort((a,b) => b._rawDate - a._rawDate)
            );
            const filteredTodoTasks = computed(() => activeCategory.value === 'å…¨éƒ¨' ? todoTasks.value : todoTasks.value.filter(t => t.category === activeCategory.value));
            const currentEventData = computed(() => activeEvent.value ? eventConfig[activeEvent.value] : {});

            const maxStatCount = computed(() => { 
                if (fiveMonthStats.value.length === 0) return 10;
                const max = Math.max(...fiveMonthStats.value.map(s => s.count)); 
                return max === 0 ? 5 : max; 
            });

            const badges = computed(() => {
                const check = (cat, target) => {
                    const list = completedTasks.value
                        .filter(t => t.category === cat)
                        .sort((a,b) => a._rawDate - b._rawDate);
                    
                    const unlocked = list.length >= target;
                    const unlockedAt = unlocked ? list[target-1]._rawDate : null;
                    return { count: list.length, unlocked, unlockedAt };
                };

                return [
                    { id: 1, name: 'é€™äººå¾ˆå‹‡', desc: 'å®Œæˆ 5 å€‹è‡ªæˆ‘æŒ‘æˆ°', target: 5, icon: 'ğŸŒ…', catFilter: 'è‡ªæˆ‘æŒ‘æˆ°', ...check('è‡ªæˆ‘æŒ‘æˆ°', 5), imgUrl: null },
                    { id: 2, name: 'å·ç‹æ˜¯ä½ ', desc: 'å®Œæˆ 3 å€‹å­¸ç¿’æˆå°±', target: 3, icon: 'ğŸ“š', catFilter: 'å­¸ç¿’æˆå°±', ...check('å­¸ç¿’æˆå°±', 3), imgUrl: null },
                    { id: 3, name: 'å®ˆè­·è€…', desc: 'å®Œæˆ 5 å€‹å®¶åº­é—œæ‡·', target: 5, icon: 'ğŸ›¡ï¸', catFilter: 'å®¶åº­é—œæ‡·', ...check('å®¶åº­é—œæ‡·', 5), imgUrl: null },
                    { id: 4, name: 'äººæ°£ç‹', desc: 'å®Œæˆ 3 å€‹å‹æƒ…å‡æº«', target: 3, icon: 'ğŸ‘‘', catFilter: 'å‹æƒ…å‡æº«', ...check('å‹æƒ…å‡æº«', 3), imgUrl: null },
                ];
            });

            const monthlyBadges = computed(() => badges.value.filter(b => b.unlocked));
            const monthlyPoints = computed(() => {
                const now = new Date();
                const thisMonthTasks = completedTasks.value.filter(t => 
                    t._rawDate.getMonth() === now.getMonth() && 
                    t._rawDate.getFullYear() === now.getFullYear()
                );
                return thisMonthTasks.length * 50;
            });

            const personaData = computed(() => {
                const total = completedTasks.value.length;
                if (total === 0) return { title: "æ²ˆç¡çš„æ½›åŠ›è‚¡", desc: "é€™å€‹æœˆä½ åœ¨é»˜é»˜ç©è“„èƒ½é‡...", topCategory: "ç„¡", colorClass: "text-slate-400" };
                
                const counts = {};
                categoryList.slice(1).forEach(c => counts[c] = 0);
                completedTasks.value.forEach(t => { if(counts[t.category] !== undefined) counts[t.category]++; });
                
                const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                const top1 = sorted[0], top2 = sorted[1];

                const traits = {
                    'è‡ªæˆ‘æŒ‘æˆ°': { n: 'æˆ°å£«', adj: 'ç„¡ç•çš„' }, 'å­¸ç¿’æˆå°±': { n: 'æ™ºè€…', adj: 'åšå­¸çš„' },
                    'å®¶åº­é—œæ‡·': { n: 'å®ˆè­·è€…', adj: 'æº«æŸ”çš„' }, 'å‹æƒ…å‡æº«': { n: 'éˆé­‚', adj: 'ç†±æƒ…çš„' },
                    'å­¸ç¿’æ¢ç´¢': { n: 'æ¢éšªå®¶', adj: 'å¥½å¥‡çš„' }, 'ç¤¾æœƒåƒèˆ‡': { n: 'å¥‰ç»è€…', adj: 'ç„¡ç§çš„' }
                };

                const isBalanced = sorted[0][1] > 0 && (sorted[0][1] - sorted[2][1] <= 1);
                let title, desc, colorClass;

                if (isBalanced && total >= 5) {
                    title = "å…¨èƒ½ç”Ÿæ´»å®¶"; desc = "ä½ çš„ç”Ÿæ´»å¹³è¡¡å¾—ä»¤äººç¾¨æ…•ï¼"; colorClass = "text-amber-400";
                } else if (top1[1] >= total * 0.6) {
                    title = `æ¥µè‡´çš„${traits[top1[0]].n}`; desc = `é€™å€‹æœˆä½ å…¨å¿ƒæŠ•å…¥åœ¨ã€Œ${top1[0]}ã€ã€‚`; colorClass = "text-blue-400";
                } else {
                    title = `${traits[top2[0]].adj}${traits[top1[0]].n}`; desc = `ä½ å®Œç¾èåˆäº†ã€Œ${top1[0]}ã€èˆ‡ã€Œ${top2[0]}ã€ã€‚`; colorClass = "text-rose-400";
                }
                return { title, desc, topCategory: top1[0], colorClass };
            });

            async function fetchUserData(userId) {
                try {
                    loadingText.value = "æ­£åœ¨åŒæ­¥æ‚¨çš„å†’éšªç´€éŒ„...";
                    currentUserId.value = userId;

                    const [tasksSnap, userDoc, userTasksDoc] = await Promise.all([
                        getDocs(collection(db, 'tasks')),
                        getDoc(doc(db, 'users', userId)),
                        getDoc(doc(db, 'user_tasks', userId))
                    ]);

                    if (userDoc.exists()) {
                        userPoints.value = userDoc.data().points ?? 0;
                    } else {
                        await setDoc(doc(db, 'users', userId), { points: 50, name: username.value });
                        userPoints.value = 50;
                    }

                    const masterTasks = {};
                    tasksSnap.forEach(d => masterTasks[d.id] = { id: d.id, ...d.data() });

                    const userRecords = userTasksDoc.exists() ? userTasksDoc.data() : {};
                    
                    const merged = Object.keys(masterTasks).map(tid => {
                        const t = masterTasks[tid];
                        const record = userRecords[tid]; 

                        if (record && record.status === 'completed') {
                            const d = parseDate(record.completedAt);
                            return {
                                ...t,
                                status: 'completed',
                                completedAt: d.toISOString(),
                                _rawDate: d,
                                photoUrl: fixPhotoUrl(record.photoUrl)
                            };
                        }
                        return { ...t, status: 'todo' };
                    });

                    tasks.value = merged;
                    calculateStats(merged.filter(t => t.status === 'completed'));
                    isLoading.value = false;

                } catch (e) {
                    console.error(e);
                    isError.value = true;
                    errorMessage.value = "åŒæ­¥è³‡æ–™å¤±æ•—: " + e.message;
                    isLoading.value = false;
                }
            }
            
            function calculateStats(doneTasks) {
                const stats = [];
                const now = new Date();
                for (let i = 4; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const y = d.getFullYear();
                    const m = d.getMonth();
                    
                    const count = doneTasks.filter(t => {
                        if (!t._rawDate) return false;
                        return t._rawDate.getFullYear() === y && t._rawDate.getMonth() === m;
                    }).length;
                    
                    stats.push({ 
                        month: i === 0 ? 'æœ¬æœˆ' : (m + 1) + 'æœˆ', 
                        count: count, 
                        isCurrent: i === 0 
                    });
                }
                fiveMonthStats.value = stats;
            }

            async function redeem(item) {
                if (userPoints.value >= item.cost) {
                    const newP = userPoints.value - item.cost;
                    await updateDoc(doc(db, 'users', currentUserId.value), { points: newP });
                    userPoints.value = newP;
                    confetti({particleCount:100,spread:70,origin:{y:0.6}}); 
                    alert("ğŸ‰ å…Œæ›æˆåŠŸï¼");
                } else {
                    alert("ç©åˆ†ä¸è¶³ï¼Œå¿«å»å®Œæˆå†’éšªä»»å‹™ï¼");
                }
            }

            const getBarStyle = (count, index) => {
                const max = maxStatCount.value || 1; 
                let pct = (count / max) * 100;
                if (count === 0) pct = 2; 
                return {
                    height: `${pct}%`,
                    transitionDelay: `${index * 100}ms`
                };
            };
            const minDate = computed(() => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow.toISOString().split('T')[0];
            });

            onMounted(async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page');
                const event = urlParams.get('event');

                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (liff.isLoggedIn()) {
                        const p = await liff.getProfile();
                        username.value = p.displayName;
                        userAvatar.value = p.pictureUrl;
                        await fetchUserData(p.userId);
                        
                        setTimeout(() => {
                            if (page === 'recap') openRecap();
                            else if (page === 'tasks') currentTab.value = 'tasks';
                            else if (page === 'badges') currentTab.value = 'badges';
                            else if (page === 'event') {
                                currentTab.value = 'event';
                                if (event && eventConfig[event]) setTimeout(() => openEvent(event), 300);
                            }
                            else if (page === 'shop') currentTab.value = 'shop';
                        }, 200);
                    } else {
                        liff.login();
                    }
                } catch (err) {
                    console.error("LIFF Init Failed", err);
                    isError.value = true;
                    errorMessage.value = "LIFF Login Failed: " + err.message;
                    isLoading.value = false;
                }
            });

            const getCategoryColor = (cat) => ({ 'è‡ªæˆ‘æŒ‘æˆ°': 'bg-rose-500 text-rose-500', 'å­¸ç¿’æˆå°±': 'bg-sky-500 text-sky-500', 'å®¶åº­é—œæ‡·': 'bg-amber-500 text-amber-500', 'å‹æƒ…å‡æº«': 'bg-pink-500 text-pink-500', 'å­¸ç¿’æ¢ç´¢': 'bg-indigo-500 text-indigo-500', 'ç¤¾æœƒåƒèˆ‡': 'bg-emerald-500 text-emerald-500' })[cat] || 'bg-slate-500 text-slate-500';
            const taskImage = (t) => t.photoUrl; 
            const getLineDeepLink = (task) => {
                if (!task || !task.title) return '#'; 
                const messageContent = `#ä¸Šå‚³:${task.title}`;
                return `https://line.me/R/oaMessage/@620hhxpv/?${encodeURIComponent(messageContent)}`;
            };
            const openTaskDetail = (t) => selectedTask.value = t;
            const openBadgeDetail = (b) => selectedBadge.value = b;
            const getBadgeTasks = (b) => completedTasks.value.filter(t => t.category === b.catFilter);
            const vibrateDevice = () => { if (navigator && navigator.vibrate) navigator.vibrate(50); };
            
            const getDay = (d) => { try { return d ? new Date(d).getDate() : '-'; } catch { return '-'; } };
            const getMonth = (d) => { try { return d ? new Date(d).toLocaleString('en-US', { month: 'short' }) : '-'; } catch { return '-'; } };
            const formatDateShort = (d) => { try { return d ? new Date(d).toLocaleDateString() : ''; } catch { return ''; } };
            const formatDateFull = (d) => { try { return d ? new Date(d).toLocaleString() : ''; } catch { return ''; } };

            const shareRecap = () => { confetti({particleCount:150,spread:60,origin:{y:0.6}}); alert("å·²è¤‡è£½åˆ†äº«é€£çµï¼"); };
            const openRecap = () => { showRecap.value = true; recapStep.value = 1; confetti({particleCount:150,spread:70,origin:{y:0.6}}); };
            const nextRecapStep = () => { if(recapStep.value < 3) recapStep.value++; else showRecap.value = false; };
            const prevRecapStep = () => { if(recapStep.value > 1) recapStep.value--; };
            const reloadApp = () => window.location.reload();
            
            const randomSnowStyle = () => ({ left: Math.random() * 100 + 'vw', animationDelay: Math.random() * 5 + 's', fontSize: (Math.random() * 10 + 10) + 'px' });

            return {
                currentUserId, username, userAvatar, userPoints, currentTab, activeCategory, categoryList, isLoading, loadingText, isError, errorMessage,
                filteredTodoTasks, completedTasks, badges, shopItems, vibrateDevice,
                selectedTask, selectedBadge, showRecap, recapStep, personaData, monthlyBadges, monthlyPoints, fiveMonthStats, maxStatCount,
                eventConfig, activeEvent, currentEventData, openEvent, randomSnowStyle,
                getCategoryColor, getLineDeepLink, openTaskDetail, openBadgeDetail, getBadgeTasks, 
                getDay, getMonth, formatDateShort, formatDateFull, redeem, shareRecap, openRecap, nextRecapStep, prevRecapStep, taskImage, getBarStyle, reloadApp,
                showSelfModal, showFriendModal, capsuleForm, generatedLink, closeModals, submitSelf, submitFriend, copyLink, minDate
            };
        }
    }).mount('#app');
</script>
</body>
</html>